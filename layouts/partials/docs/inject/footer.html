<!-- 代码块复制功能 -->
<script>
(function() {
  'use strict';

  // 等待DOM加载完成
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCopyButtons);
  } else {
    initCopyButtons();
  }

  function initCopyButtons() {
    // 获取所有代码块
    const highlights = document.querySelectorAll('.highlight');

    highlights.forEach(function(highlight) {
      // 检查是否已经添加过按钮
      if (highlight.querySelector('.copy-code-button')) {
        return;
      }

      // 创建复制按钮
      const button = document.createElement('button');
      button.className = 'copy-code-button';
      button.type = 'button';
      button.textContent = '复制';
      button.setAttribute('aria-label', '复制代码');

      // 添加点击事件
      button.addEventListener('click', function() {
        copyCode(highlight, button);
      });

      // 将按钮添加到代码块
      highlight.insertBefore(button, highlight.firstChild);
    });
  }

  function copyCode(highlight, button) {
    let code = '';

    // 方法1: 尝试从表格结构提取（Hugo Chroma with lineNos）
    const table = highlight.querySelector('table');
    if (table) {
      // 表格结构：行号在第一个td，代码在第二个td
      const rows = table.querySelectorAll('tr');
      const codeLines = [];

      rows.forEach(function(row) {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
          // 第二个单元格是代码内容
          const codeCell = cells[1];
          // 获取该单元格的文本内容
          const lineText = codeCell.textContent || codeCell.innerText;
          codeLines.push(lineText);
        } else if (cells.length === 1) {
          // 只有一个单元格，可能没有行号
          const lineText = cells[0].textContent || cells[0].innerText;
          codeLines.push(lineText);
        }
      });

      code = codeLines.join('\n');
    } else {
      // 方法2: 没有表格，尝试直接从code标签获取
      const codeElement = highlight.querySelector('code');
      if (codeElement) {
        // 克隆元素避免修改原始DOM
        const clone = codeElement.cloneNode(true);

        // 移除所有可能的行号元素
        const lineNumberElements = clone.querySelectorAll('.ln, .lnt, .line-number, [class*="line-num"]');
        lineNumberElements.forEach(function(el) {
          el.remove();
        });

        // 移除复制按钮
        const copyButtons = clone.querySelectorAll('.copy-code-button');
        copyButtons.forEach(function(btn) {
          btn.remove();
        });

        code = clone.textContent || clone.innerText;
      }
    }

    // 清理代码
    code = code.trim();

    // 如果代码为空，尝试最后的降级方案
    if (!code) {
      const pre = highlight.querySelector('pre');
      if (pre) {
        code = pre.textContent || pre.innerText;
        code = code.trim();
      }
    }

    // 复制到剪贴板
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(code).then(function() {
        showCopySuccess(button);
      }).catch(function(err) {
        console.error('复制失败:', err);
        fallbackCopyToClipboard(code, button);
      });
    } else {
      fallbackCopyToClipboard(code, button);
    }
  }

  function fallbackCopyToClipboard(text, button) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();

    try {
      document.execCommand('copy');
      showCopySuccess(button);
    } catch (err) {
      console.error('复制失败:', err);
    }

    document.body.removeChild(textarea);
  }

  function showCopySuccess(button) {
    const originalText = button.textContent;
    button.textContent = '已复制!';
    button.classList.add('copied');

    setTimeout(function() {
      button.textContent = originalText;
      button.classList.remove('copied');
    }, 2000);
  }
})();
</script>
